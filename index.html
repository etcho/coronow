<!DOCTYPE html>
<html>
    <head>
        <meta name="theme-color" content="#88d8b0" />
        <title>Coronow</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://code.jquery.com/jquery-3.5.0.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.12/js/select2.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.12/css/select2.min.css" />

        <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" />
    </head>
    <style>
        .header {
            width: 100%;
            text-align: center;
            background: #88d8b0;
            line-height: 45px;
            font-size: 30px;
            font-weight: bold;
        }

        .header span {
            font-style: italic;
            color: #ff6f69;
        }

        .container {
            padding-top: 10px;
        }

        h1 {
            font-size: 20px;
            text-align: center;
            margin-top: 20px;
            background: #ffcc5c;
            margin-bottom: 0;
            padding: 4px 0px;
            border-radius: 10px 10px 0px 0px;
        }

        .main-counter {
            background: #ffeead;
            text-align: center;
            font-size: 22px;
            padding: 10px 0px 15px;
        }

        label[for=country]{
            display: block;
        }

        #country {
            display: none;
        }

        .loading {
            font-size: 24px;
        }

        .chart-wrapper {
            border: 1px solid #ffcc5e;
            border-top: none;
        }
    </style>
    <body>
        <div class="header">Coro<span>now</span></div>
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <label for="country"><lang for="country"></lang></label>
                    <div class="loading"><i class="fas fa-virus fa-spin"></i></div>
                    <select id="country"></select>
                </div>
            </div>
            <div class="row">
                <div class="col-6 col-md-3">
                    <h1><lang for="confirmed"></lang> <i class="fas fa-clipboard-check"></i></h1>
                    <div class="main-counter" id="counter_confirmed"><i class="fas fa-virus fa-spin"></i></div>
                </div>
                <div class="col-6 col-md-3">
                    <h1><lang for="deaths"></lang> <i class="fas fa-skull"></i></h1>
                    <div class="main-counter" id="counter_deaths"><i class="fas fa-virus fa-spin"></i></div>
                </div>
                <div class="col-6 col-md-3">
                    <h1><lang for="recovered"></lang> <i class="fas fa-shield-virus"></i></h1>
                    <div class="main-counter" id="counter_recovered"><i class="fas fa-virus fa-spin"></i></div>
                </div>
                <div class="col-6 col-md-3">
                    <h1><lang for="fatality"></lang> <i class="fas fa-skull-crossbones"></i></h1>
                    <div class="main-counter" id="counter_fatality"><i class="fas fa-virus fa-spin"></i></div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <h1><lang for="overall_growth"></lang></h1>
                    <div id="wrapper-chart" class="chart-wrapper">

                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        function numberFormat(number) {
            return new Intl.NumberFormat().format(number);
        }

        function hash() {
            return window.location.hash.replace("#", "");
        }

        function jump(h) {
            window.location.href = "#" + h;
        }

        function loadLang() {
            $("lang").each(function () {
                $(this).html(lang[$(this).attr("for")]);
            });
        }

        function valuesOfKey(list, key) {
            var filtered = [];
            $(list).each(function (a, b) {
                filtered.push(b[key]);
            });
            return filtered;
        }

        function beautifyDate(date) {
            date = date.split("-");
            if (current_lang === "pt") {
                return date[2] + "/" + lang.months[date[1] - 1];
            } else {
                return lang.months[date[1] - 1] + " " + date[2];
            }
        }

        function beautifyDates(dates) {
            $(dates).each(function (a, b) {
                dates[a] = beautifyDate(b);
            });
            return dates;
        }

        function buildCharts() {
            var country = $("#country").select2("val");
            var c_data = data[country];
            var wrapper = $("#wrapper-chart");
            wrapper.html("<canvas height='200'></canvas>");
            new Chart(wrapper.find("canvas")[0], {
                type: "line",
                data: {
                    labels: beautifyDates(valuesOfKey(c_data, "date")),
                    datasets: [
                        {
                            label: lang.confirmed,
                            data: valuesOfKey(c_data, "confirmed"),
                            fill: false,
                            borderColor: "#ffcc5c",
                            lineTension: 0,
                            pointRadius: 1
                        },
                        {
                            label: lang.deaths,
                            data: valuesOfKey(c_data, "deaths"),
                            fill: true,
                            borderColor: "#ff6f69",
                            backgroundColor: "rgba(255, 0, 0, 0.3)",
                            lineTension: 0,
                            pointRadius: 1
                        },
                        {
                            label: lang.recovered,
                            data: valuesOfKey(c_data, "recovered"),
                            fill: false,
                            borderColor: "#96ceb4",
                            lineTension: 0,
                            pointRadius: 0,
                            borderDash: [5, 10]
                        }
                    ]
                },
                options: {}
            });
        }

        var data = [];
        var current_lang = navigator.language.split("-")[0];
        var lang = {};
        if (current_lang === "pt") {
            lang = {
                country: "Pa√≠s",
                confirmed: "Confirmados",
                deaths: "Mortes",
                recovered: "Recuperados",
                fatality: "Fatalidade",
                all_world: "Mundo Todo",
                overall_growth: "Crescimento geral",
                months: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"]
            };
        } else {
            lang = {
                country: "Country",
                confirmed: "Confirmed",
                deaths: "Deaths",
                recevered: "Recovered",
                fatality: "Fatality",
                all_world: "All World",
                overall_growth: "Overall growth",
                months: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
            };
        }

        $(document).ready(function () {
            loadLang();

            $.ajax({
                url: "https://pomber.github.io/covid19/timeseries.json",
                dataType: "json",
                success: function (d) {
                    data = d;
                    var world = [];
                    $("#country").append('<option value="world">' + lang.all_world + '</option>');
                    $(Object.keys(data)).each(function (a, b) {
                        $("#country").append('<option value="' + b + '">' + b + '</option>');
                        $(data[b]).each(function (c, d) {
                            var found = false;
                            $(world).each(function (e, f) {
                                if (f.date === d.date) {
                                    world[e].confirmed += d.confirmed;
                                    world[e].deaths += d.deaths;
                                    world[e].recovered += d.recovered;
                                    found = true;
                                }
                            });
                            if (!found) {
                                world.push({date: d.date, confirmed: d.confirmed, deaths: d.deaths, recovered: d.recovered});
                            }
                        });
                    });
                    data.world = world;
                    if (hash().length > 0) {
                        $("#country option").each(function () {
                            if ($(this).attr("value").toLowerCase() === hash().toLowerCase()) {
                                $(this).prop("selected", true);
                            }
                        });
                    }
                    $("select").show().select2().trigger("change");
                    $(".loading").hide();
                }
            });

            $("#country").on("change", function () {
                var country = $(this).select2("val");
                var d = data[country];
                var last = d[d.length - 1];
                $("#counter_confirmed").html(numberFormat(last.confirmed));
                $("#counter_deaths").html(numberFormat(last.deaths));
                $("#counter_recovered").html(numberFormat(last.recovered));
                $("#counter_fatality").html(numberFormat((last.deaths / (last.confirmed) * 100).toFixed(1)) + "%");
                jump(country);
                buildCharts();
            });
        });
    </script>
</html>
